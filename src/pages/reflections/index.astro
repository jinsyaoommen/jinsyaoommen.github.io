---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = post.data.pubDate.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<Layout title="Reflections | Jinsy Oommen">
  <section class="blog">
    <div class="header">
      <h1>Reflections</h1>
      <p class="intro">Feel free to copy and adapt this. It's the accumulation of years of listening, observing, and learning from the people around me, from seeing both what works and what doesn't. None of this came from one place or one moment. It takes a village to grow wisdom, and this is my small reflection of that shared learning.</p>
      <div id="search" class="search-container"></div>
    </div>

    <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
    <script src="/pagefind/pagefind-ui.js" is:inline></script>
    <script is:inline>
      window.addEventListener('DOMContentLoaded', () => {
        new PagefindUI({
          element: "#search",
          showSubResults: true,
          showImages: false,
        });
      });
    </script>

    <div class="layout">
      <div class="content">
        {years.map((year) => (
          <div class="year-group" id={`year-${year}`}>
            <h2 class="year">{year}</h2>
            <div class="posts">
              {postsByYear[Number(year)].map((post) => (
                <div class="post" data-href={`/reflections/${post.id}`} role="link" tabindex="0" aria-label={`Read ${post.data.title}`}>
                  <span class="date">
                    {post.data.pubDate.toLocaleDateString('en-US', {
                      month: 'long',
                      day: 'numeric',
                    })}
                  </span>
                  <h3>{post.data.title}</h3>
                  <p>{post.data.description}</p>
                  {post.data.tags.length > 0 && (
                    <div class="tags">
                      {post.data.tags.map((tag: string) => (
                        <a href={`/reflections/tags/${tag}`} class="tag">{tag}</a>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        ))}

        {posts.length === 0 && (
          <p class="empty">No posts yet. Check back soon!</p>
        )}
      </div>

      <aside class="sidebar">
        <nav class="year-nav">
          <span class="nav-label">Jump to</span>
          {years.map((year) => (
            <a href={`#year-${year}`} class="year-link">{year}</a>
          ))}
        </nav>
      </aside>
    </div>
  </section>
</Layout>

<script is:inline>
  document.querySelectorAll('.post[data-href]').forEach(post => {
    post.style.cursor = 'pointer';
    post.addEventListener('click', (e) => {
      if (e.target.closest('.tag')) return;
      window.location.href = post.dataset.href;
    });
    post.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        window.location.href = post.dataset.href;
      }
    });
  });
</script>

<style>
  .blog {
    padding: 4rem 0;
    min-height: calc(100vh - 64px);
  }

  .header {
    max-width: 1000px;
    margin: 0 auto 2rem;
    padding: 0 2rem;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #2d2d2d;
  }

  .intro {
    font-size: 1rem;
    color: #666;
    font-style: italic;
    max-width: 700px;
  }

  .search-container {
    margin-top: 1.5rem;
    max-width: 500px;
  }

  .search-container :global(.pagefind-ui__search-input) {
    border-radius: 4px;
    border: 1px solid #e5e5e5;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    font-size: 0.95rem;
  }

  .search-container :global(.pagefind-ui__search-icon) {
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
  }

  .search-container :global(.pagefind-ui__search-clear) {
    border-radius: 4px;
  }

  .search-container :global(.pagefind-ui__result-link) {
    color: #2d2d2d;
  }

  .search-container :global(.pagefind-ui__result-link:hover) {
    color: #7c9eb2;
  }

  .layout {
    display: flex;
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 2rem;
    gap: 3rem;
  }

  .content {
    flex: 1;
    max-width: 700px;
  }

  .sidebar {
    flex-shrink: 0;
    width: 100px;
  }

  .year-nav {
    position: sticky;
    top: 4rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .nav-label {
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.25rem;
  }

  .year-link {
    font-size: 0.9rem;
    color: #666;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .year-link:hover {
    color: #2d2d2d;
  }

  .year-group {
    margin-bottom: 3rem;
    scroll-margin-top: 2rem;
  }

  .year {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2d2d2d;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e5e5e5;
  }

  .posts {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .post {
    display: block;
    padding: 1.5rem;
    background: #f9f9f9;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .post:hover,
  .post:focus {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .post:focus {
    outline: 2px solid #7c9eb2;
    outline-offset: 2px;
  }

  .date {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .post h3 {
    font-size: 1.25rem;
    font-weight: 500;
    color: #2d2d2d;
    margin: 0.5rem 0;
  }

  .post p {
    font-size: 0.95rem;
    color: #666;
    line-height: 1.6;
    margin: 0;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-top: 0.75rem;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    height: 27px;
    font-size: 0.7rem;
    line-height: 1;
    padding: 0 0.4rem;
    background: #e5e5e5;
    color: #666;
    border-radius: 2px;
    text-decoration: none;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .tag:hover {
    background: #7c9eb2;
    color: white;
  }

  .empty {
    color: #888;
  }

  @media (max-width: 768px) {
    .layout {
      flex-direction: column-reverse;
      gap: 1.5rem;
    }

    .sidebar {
      width: 100%;
    }

    .year-nav {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
    }

    .nav-label {
      width: 100%;
    }
  }
</style>
